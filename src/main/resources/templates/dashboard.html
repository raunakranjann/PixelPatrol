<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>PixelPatrol Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        .zoomable {
            cursor: zoom-in;
            transition: transform 0.2s;
        }
        .zoomable:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 pb-10">

<nav class="bg-indigo-600 text-white p-4 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold"><i class="fas fa-eye"></i> PixelPatrol</h1>
            <span class="text-sm bg-indigo-700 px-3 py-1 rounded">Local Mode</span>
        </div>

        <button onclick="runBatch()" id="btn-batch" class="bg-white text-indigo-700 hover:bg-gray-100 font-bold py-2 px-4 rounded shadow transition flex items-center gap-2">
            <i class="fas fa-layer-group"></i> <span>Check All Monitors</span>
        </button>
    </div>
</nav>

<div class="container mx-auto p-6 grid grid-cols-1 md:grid-cols-3 gap-6">

    <div class="bg-white p-6 rounded-lg shadow-md h-fit">
        <h2 class="text-xl font-semibold mb-4 text-indigo-600">Add New Monitor</h2>
        <form th:action="@{/project}" th:object="${newProject}" method="post">
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">Project Name</label>
                <input type="text" th:field="*{name}" placeholder="e.g. Landing Page" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">Staging URL (Dev)</label>
                <input type="url" th:field="*{stagingUrl}" placeholder="http://localhost:8080" class="w-full p-2 border rounded" required>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-bold mb-2">Production URL (Live)</label>
                <input type="url" th:field="*{productionUrl}" placeholder="https://example.com" class="w-full p-2 border rounded" required>
            </div>
            <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded transition">
                <i class="fas fa-plus"></i> Save Project
            </button>
        </form>
    </div>

    <div class="md:col-span-2 space-y-4">
        <h2 class="text-xl font-semibold mb-2">Active Monitors</h2>

        <div th:each="project : ${projects}" class="bg-white p-4 rounded-lg shadow hover:shadow-lg transition border-l-4 border-indigo-500 flex justify-between items-center">
            <div>
                <h3 class="text-lg font-bold" th:text="${project.name}">Project Name</h3>
                <div class="text-sm text-gray-500 mt-1">
                    <p><i class="fas fa-server"></i> Staging: <span class="text-blue-500" th:text="${project.stagingUrl}">url</span></p>
                    <p><i class="fas fa-globe"></i> Prod: <span class="text-green-500" th:text="${project.productionUrl}">url</span></p>
                </div>
            </div>

            <div class="flex gap-2 items-center">
                <span th:id="'badge-' + ${project.id}" class="hidden px-2 py-1 text-xs font-bold rounded shadow-sm border"></span>

                <button th:id="'btn-run-' + ${project.id}" th:data-id="${project.id}" onclick="runTest(this)" class="bg-green-100 text-green-700 px-4 py-2 rounded font-bold hover:bg-green-200 transition flex items-center gap-2">
                    <i class="fas fa-play"></i> <span>Run Test</span>
                </button>

                <form th:action="@{/project/delete/{id}(id=${project.id})}" method="post" onsubmit="return confirm('Are you sure you want to delete this monitor?');">
                    <button type="submit" class="bg-red-100 text-red-600 px-3 py-2 rounded hover:bg-red-200 hover:text-red-800 transition" title="Delete Monitor">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </form>
            </div>
        </div>

        <div th:if="${projects.empty}" class="text-center py-10 text-gray-400">
            <i class="fas fa-ghost text-4xl mb-2"></i>
            <p>No projects found. Add one on the left!</p>
        </div>

        <div id="result-area" class="hidden mt-8 bg-white p-6 rounded-lg shadow-xl border-t-4 border-gray-800 animate-fade-in-up">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Test Result</h2>
                    <p id="result-status-text" class="text-sm font-bold mt-1">Waiting...</p>
                </div>
                <button id="download-pdf-btn" class="hidden bg-gray-800 text-white px-4 py-2 rounded hover:bg-gray-700 transition shadow-lg flex items-center gap-2">
                    <i class="fas fa-file-pdf"></i> Download PDF Report
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="text-center">
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Staging (Baseline)</span>
                    <div class="mt-3 border-2 border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition bg-gray-50">
                        <img id="img-staging" onclick="openModal(this.src)" class="zoomable w-full object-contain min-h-[200px]" src="" alt="Staging Screenshot" />
                    </div>
                </div>

                <div class="text-center">
                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide">Production (Current)</span>
                    <div class="mt-3 border-2 border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition bg-gray-50">
                        <img id="img-prod" onclick="openModal(this.src)" class="zoomable w-full object-contain min-h-[200px]" src="" alt="Production Screenshot" />
                    </div>
                </div>
            </div>
            <p class="text-center text-gray-400 text-xs mt-4">Tip: Click on any image to enlarge.</p>
        </div>
    </div>
</div>

<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-[100] flex justify-center items-center" onclick="closeModal()">
    <span class="absolute top-5 right-5 text-white text-4xl cursor-pointer hover:text-gray-300">&times;</span>
    <img id="modal-img" class="max-w-[95%] max-h-[95%] rounded shadow-2xl border border-gray-700" src="" />
</div>

<script>
    // --- MODAL LOGIC ---
    function openModal(src) {
        if(!src || src.includes('undefined')) return;
        const modal = document.getElementById("image-modal");
        const modalImg = document.getElementById("modal-img");
        modalImg.src = src;
        modal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
    }

    function closeModal() {
        const modal = document.getElementById("image-modal");
        modal.classList.add("hidden");
        document.body.style.overflow = "auto";
    }

    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") closeModal();
    });

    // --- SINGLE TEST RUNNER LOGIC ---
    async function runTest(btn) {
        const projectId = btn.getAttribute("data-id");
        const badge = document.getElementById('badge-' + projectId);

        const originalText = btn.innerHTML;
        const originalClasses = btn.className;

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;
        btn.classList.add("opacity-50", "cursor-not-allowed");

        // Hide badge during run
        badge.classList.add('hidden');

        try {
            const response = await fetch('/api/run-test/' + projectId, { method: 'POST' });
            if (!response.ok) throw new Error("Network response was not ok");
            const data = await response.json();

            // Select Elements
            const resultArea = document.getElementById("result-area");
            const statusText = document.getElementById("result-status-text");
            const stagingImg = document.getElementById("img-staging");
            const prodImg = document.getElementById("img-prod");
            const pdfBtn = document.getElementById("download-pdf-btn");

            // 1. ERROR
            if (data.status === "ERROR") {
                statusText.innerText = data.message;
                statusText.className = "text-sm font-bold mt-1 text-orange-600";

                btn.className = "bg-orange-500 text-white px-4 py-2 rounded font-bold transition flex items-center gap-2";
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                alert(data.message);

                resultArea.classList.remove("hidden");
                stagingImg.src = ""; prodImg.src = "";
                pdfBtn.classList.add("hidden");

                setTimeout(() => { btn.disabled = false; btn.classList.remove("opacity-50", "cursor-not-allowed"); }, 1000);
                return;
            }

            // 2. SUCCESS (PASS/FAIL)
            const timestamp = new Date().getTime();
            stagingImg.src = "/api/images/" + data.stagingImg + "?t=" + timestamp;
            prodImg.src = "/api/images/" + data.prodImg + "?t=" + timestamp;

            resultArea.classList.remove("hidden");
            pdfBtn.classList.remove("hidden");
            pdfBtn.onclick = function() { window.open(data.reportUrl, '_blank'); };

            if (data.status === "PASS") {
                statusText.innerText = "✅ PASSED: Identical.";
                statusText.className = "text-sm font-bold mt-1 text-green-600";

                btn.className = "bg-green-500 text-white px-4 py-2 rounded font-bold transition flex items-center gap-2";
                btn.innerHTML = '<i class="fas fa-check"></i> Passed';

                // Badge Logic
                badge.className = "px-2 py-1 text-xs font-bold rounded bg-green-100 text-green-800 border border-green-200";
                badge.innerText = "0% Diff";
                badge.classList.remove('hidden');

            } else {
                statusText.innerText = "❌ FAILED: " + data.diffPercent + "% Diff";
                statusText.className = "text-sm font-bold mt-1 text-red-600";

                btn.className = "bg-red-500 text-white px-4 py-2 rounded font-bold transition flex items-center gap-2";
                btn.innerHTML = '<i class="fas fa-bug"></i> Failed';

                // Badge Logic
                badge.className = "px-2 py-1 text-xs font-bold rounded bg-red-100 text-red-800 border border-red-200";
                badge.innerText = data.diffPercent + "% Diff";
                badge.classList.remove('hidden');
            }

            resultArea.scrollIntoView({ behavior: 'smooth', block: 'center' });

        } catch (error) {
            console.error(error);
            alert("System Error");
            btn.innerHTML = originalText;
            btn.className = originalClasses;
            btn.disabled = false;
        } finally {
            if (!btn.innerHTML.includes("Error")) {
                btn.disabled = false;
                btn.classList.remove("opacity-50", "cursor-not-allowed");
            }
        }
    }

    // --- BATCH RUNNER LOGIC (UPDATED WITH UI REFRESH) ---
    async function runBatch() {
        const btn = document.getElementById("btn-batch");
        const originalContent = '<i class="fas fa-layer-group"></i> <span>Check All Monitors</span>';

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Processing All...';
        btn.classList.add("opacity-75");

        // Set all buttons to Queued
        document.querySelectorAll('[id^="btn-run-"]').forEach(pb => {
            pb.innerHTML = '<i class="fas fa-clock"></i> Queued...';
            pb.classList.add("opacity-50");
        });

        try {
            const response = await fetch('/api/run-all', { method: 'POST' });
            if (!response.ok) throw new Error("Batch failed");
            const data = await response.json();

            // --- UPDATE INDIVIDUAL CARDS ---
            if(data.results) {
                data.results.forEach(r => {
                    const projectBtn = document.getElementById('btn-run-' + r.projectId);
                    const projectBadge = document.getElementById('badge-' + r.projectId);

                    if(projectBtn) {
                        projectBtn.classList.remove("opacity-50", "cursor-not-allowed", "bg-green-100", "text-green-700");

                        if (r.errorMessage) {
                            // ERROR STATE
                            projectBtn.className = "bg-orange-500 text-white px-4 py-2 rounded font-bold flex items-center gap-2";
                            projectBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                            projectBadge.classList.add('hidden'); // Hide badge on error

                        } else if (r.passed) {
                            // PASS STATE
                            projectBtn.className = "bg-green-500 text-white px-4 py-2 rounded font-bold flex items-center gap-2";
                            projectBtn.innerHTML = '<i class="fas fa-check"></i> Passed';

                            projectBadge.className = "px-2 py-1 text-xs font-bold rounded bg-green-100 text-green-800 border border-green-200";
                            projectBadge.innerText = "0% Diff";
                            projectBadge.classList.remove('hidden');

                        } else {
                            // FAIL STATE
                            projectBtn.className = "bg-red-500 text-white px-4 py-2 rounded font-bold flex items-center gap-2";
                            projectBtn.innerHTML = '<i class="fas fa-bug"></i> Failed';

                            projectBadge.className = "px-2 py-1 text-xs font-bold rounded bg-red-100 text-red-800 border border-red-200";
                            // Format percentage safely
                            const pct = r.diffPercent ? r.diffPercent.toFixed(2) : "0.00";
                            projectBadge.innerText = pct + "% Diff";
                            projectBadge.classList.remove('hidden');
                        }
                    }
                });
            }

            alert(data.message);

            // Turn Batch Button into Download Button
            btn.disabled = false;
            btn.classList.remove("opacity-75", "bg-white", "text-indigo-700");
            btn.classList.add("bg-green-500", "text-white", "hover:bg-green-600");
            btn.innerHTML = '<i class="fas fa-file-download"></i> <span>Download Report</span>';

            btn.onclick = function() {
                window.open(data.reportUrl, '_blank');
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.remove("bg-green-500", "text-white", "hover:bg-green-600");
                    btn.classList.add("bg-white", "text-indigo-700");
                    btn.onclick = runBatch;
                    // Reset small buttons back to "Run Test" state
                    document.querySelectorAll('[id^="btn-run-"]').forEach(pb => {
                        pb.innerHTML = '<i class="fas fa-play"></i> <span>Run Test</span>';
                        pb.className = "bg-green-100 text-green-700 px-4 py-2 rounded font-bold hover:bg-green-200 transition flex items-center gap-2";
                    });
                }, 3000);
            };

        } catch (error) {
            console.error(error);
            alert("Batch run failed.");
            btn.disabled = false;
            btn.innerHTML = originalContent;
            btn.classList.remove("opacity-75");
        }
    }
</script>

</body>
</html>