<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>PixelPatrol | Collections</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .zoomable { cursor: zoom-in; transition: transform 0.2s; }
        .zoomable:hover { opacity: 0.9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col overflow-hidden">

<nav class="bg-indigo-700 text-white p-3 shadow-lg z-50 flex justify-between items-center shrink-0">
    <div class="flex items-center gap-3">
        <h1 class="text-xl font-bold tracking-wide"><i class="fas fa-eye"></i> PixelPatrol</h1>
        <span class="text-xs bg-indigo-800 px-2 py-1 rounded text-indigo-200 uppercase font-bold tracking-wider">Workspace</span>
    </div>

    <div class="flex gap-3">
        <form th:action="@{/api/collections}" method="post" class="flex shadow-sm">
            <input type="text" name="name" placeholder="New Collection Name..." class="px-3 py-1 rounded-l text-gray-800 text-sm focus:outline-none w-48 border-0" required>
            <button type="submit" class="bg-indigo-500 hover:bg-indigo-400 px-3 py-1 rounded-r text-sm font-bold transition border-l border-indigo-600">
                <i class="fas fa-folder-plus"></i>
            </button>
        </form>

        <button onclick="runBatch()" id="btn-batch" class="bg-white text-indigo-700 hover:bg-gray-50 text-sm font-bold py-1 px-4 rounded shadow transition flex items-center gap-2">
            <i class="fas fa-play-circle"></i> <span>Run Everything</span>
        </button>
    </div>
</nav>

<div class="flex flex-1 overflow-hidden relative">

    <div class="w-80 bg-white shadow-xl z-30 flex flex-col border-r border-gray-200">
        <div class="p-4 bg-gray-50 border-b flex items-center gap-2 text-gray-700">
            <i class="fas fa-plus-circle text-indigo-600"></i>
            <h2 class="font-bold text-sm uppercase tracking-wide">New Monitor</h2>
        </div>

        <div class="p-5 overflow-y-auto flex-1">
            <form th:action="@{/project}" th:object="${newProject}" method="post" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Collection</label>
                    <select name="collectionId" class="w-full p-2 text-sm border border-gray-300 rounded bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                        <option value="">-- Uncategorized --</option>
                        <option th:each="col : ${collections}" th:value="${col.id}" th:text="${col.name}"></option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label>
                    <input type="text" th:field="*{name}" placeholder="e.g. Login Page" class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 transition" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Staging URL</label>
                    <input type="url" th:field="*{stagingUrl}" placeholder="http://localhost:..." class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 transition" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Production URL</label>
                    <input type="url" th:field="*{productionUrl}" placeholder="https://..." class="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 transition" required>
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded transition shadow-md text-sm mt-2">
                    Save Monitor
                </button>
            </form>
            <div class="mt-8 pt-6 border-t border-dashed">
                <p class="text-xs text-gray-400 text-center">PixelPatrol v1.0 <br> Local Environment</p>
            </div>
        </div>
    </div>

    <div class="flex-1 bg-gray-100 p-6 overflow-y-auto">

        <div th:each="col : ${collections}" th:id="'col-group-' + ${col.id}" class="mb-8 animate-fade-in-up">
            <div class="flex justify-between items-center mb-3 group border-b pb-2 border-gray-300">
                <h3 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                    <i class="fas fa-folder-open text-yellow-500"></i>
                    <span th:text="${col.name}">Collection Name</span>
                    <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full font-medium" th:text="${col.projects.size()}">0</span>
                </h3>

                <div class="flex gap-3 items-center transition">

                    <button th:id="'btn-col-report-' + ${col.id}" class="hidden text-green-600 hover:text-green-800 text-xs font-bold uppercase flex items-center gap-1 transition mr-2 border border-green-200 bg-green-50 px-2 py-1 rounded shadow-sm" title="Download Report">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>

                    <button type="button" th:onclick="'runCollection(' + ${col.id} + ')'" class="text-indigo-600 hover:text-indigo-800 text-xs font-bold uppercase flex items-center gap-1 transition mr-2" title="Run all monitors in this collection">
                        <i class="fas fa-play"></i> Run Set
                    </button>

                    <div class="h-4 w-px bg-gray-300"></div>

                    <form th:action="@{/api/collections/delete/{id}(id=${col.id})}" method="post" onsubmit="return confirm('Delete this collection and all its monitors?');">
                        <button class="text-gray-400 hover:text-red-500 px-1 transition" title="Delete Collection"><i class="fas fa-trash-alt"></i></button>
                    </form>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <div th:each="project : ${col.projects}" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition hover:border-indigo-300 relative group">
                    <div class="flex justify-between items-start mb-3">
                        <div class="overflow-hidden">
                            <h4 class="font-bold text-gray-800 text-sm truncate" th:text="${project.name}">Name</h4>
                            <div class="text-[10px] text-gray-400 mt-1 space-y-0.5 font-mono">
                                <p class="truncate"><i class="fas fa-server w-3"></i> <span th:text="${project.stagingUrl}"></span></p>
                                <p class="truncate"><i class="fas fa-globe w-3"></i> <span th:text="${project.productionUrl}"></span></p>
                            </div>
                        </div>
                        <span th:id="'badge-' + ${project.id}" class="hidden px-1.5 py-0.5 text-[10px] font-bold uppercase rounded border ml-2 shrink-0"></span>
                    </div>
                    <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
                        <button th:id="'btn-run-' + ${project.id}" th:data-id="${project.id}" onclick="runTest(this)" class="flex-1 bg-gray-50 hover:bg-indigo-50 text-gray-600 hover:text-indigo-700 text-xs font-bold py-1.5 rounded transition flex justify-center items-center gap-2 border border-gray-200">
                            <i class="fas fa-play"></i> Run
                        </button>
                        <form th:action="@{/project/delete/{id}(id=${project.id})}" method="post" onsubmit="return confirm('Delete monitor?');">
                            <button class="bg-white border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-200 px-3 py-1.5 rounded text-xs transition"><i class="fas fa-trash"></i></button>
                        </form>
                    </div>
                </div>
            </div>
            <div th:if="${col.projects.empty}" class="text-center py-4 bg-gray-50 rounded-lg border border-dashed border-gray-300 text-gray-400 text-sm italic">
                Empty Collection
            </div>
        </div>

        <div th:if="${!looseProjects.empty}" class="mb-10">
            <div class="flex justify-between items-center mb-3 border-b pb-2 border-gray-300">
                <h3 class="text-lg font-bold text-gray-500 flex items-center gap-2">
                    <i class="fas fa-box-open"></i> Uncategorized
                    <span class="text-xs bg-gray-200 text-gray-500 px-2 py-0.5 rounded-full font-medium" th:text="${looseProjects.size()}">0</span>
                </h3>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4">
                <div th:each="project : ${looseProjects}" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:shadow-md transition relative">
                    <div class="flex justify-between items-start mb-3">
                        <div class="overflow-hidden">
                            <h4 class="font-bold text-gray-800 text-sm truncate" th:text="${project.name}">Name</h4>
                            <div class="text-[10px] text-gray-400 mt-1 space-y-0.5 font-mono">
                                <p class="truncate"><i class="fas fa-server w-3"></i> <span th:text="${project.stagingUrl}"></span></p>
                                <p class="truncate"><i class="fas fa-globe w-3"></i> <span th:text="${project.productionUrl}"></span></p>
                            </div>
                        </div>
                        <span th:id="'badge-' + ${project.id}" class="hidden px-1.5 py-0.5 text-[10px] font-bold uppercase rounded border ml-2 shrink-0"></span>
                    </div>
                    <div class="flex gap-2 mt-3 pt-3 border-t border-gray-100">
                        <button th:id="'btn-run-' + ${project.id}" th:data-id="${project.id}" onclick="runTest(this)" class="flex-1 bg-gray-50 hover:bg-indigo-50 text-gray-600 hover:text-indigo-700 text-xs font-bold py-1.5 rounded transition flex justify-center items-center gap-2 border border-gray-200">
                            <i class="fas fa-play"></i> Run
                        </button>
                        <form th:action="@{/project/delete/{id}(id=${project.id})}" method="post" onsubmit="return confirm('Delete monitor?');">
                            <button class="bg-white border border-gray-200 text-gray-400 hover:text-red-500 hover:border-red-200 px-3 py-1.5 rounded text-xs transition"><i class="fas fa-trash"></i></button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="result-panel" class="w-[600px] bg-white shadow-2xl z-40 border-l border-gray-200 transform translate-x-full transition-transform duration-300 ease-in-out flex flex-col absolute right-0 top-0 bottom-0 h-full">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50 shrink-0">
            <h2 class="font-bold text-gray-700 flex items-center gap-2"><i class="fas fa-poll-h"></i> Test Results</h2>
            <button onclick="closeResult()" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div id="result-content" class="p-6 flex-1 overflow-y-auto">
            <div id="result-status-area" class="text-center mb-8 pb-6 border-b border-gray-100">
                <div id="result-icon" class="text-5xl mb-3 text-gray-300"><i class="fas fa-microscope"></i></div>
                <h3 id="result-title" class="text-2xl font-bold text-gray-800">Ready</h3>
                <p id="result-desc" class="text-sm text-gray-500 mt-1">Select a test to view results.</p>
                <button id="pdf-btn" class="hidden mt-4 bg-indigo-600 text-white px-5 py-2 rounded-full text-sm font-bold shadow hover:bg-indigo-700 transition transform active:scale-95">
                    <i class="fas fa-file-download mr-2"></i> Download Report
                </button>
            </div>
            <div id="result-images" class="space-y-6 hidden">
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs font-bold text-blue-600 uppercase tracking-wider bg-blue-50 px-2 py-0.5 rounded">Staging (Baseline)</span>
                    </div>
                    <div class="border rounded bg-gray-50 p-1">
                        <img id="img-staging" class="w-full h-auto rounded shadow-sm cursor-zoom-in hover:opacity-95 transition" onclick="openModal(this.src)">
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span class="text-xs font-bold text-green-600 uppercase tracking-wider bg-green-50 px-2 py-0.5 rounded">Production (Current)</span>
                    </div>
                    <div class="border rounded bg-gray-50 p-1">
                        <img id="img-prod" class="w-full h-auto rounded shadow-sm cursor-zoom-in hover:opacity-95 transition" onclick="openModal(this.src)">
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div id="progress-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-[200] flex flex-col justify-center items-center backdrop-blur-sm transition-opacity">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-lg text-center transform scale-100 transition-transform">
        <div class="mb-4 text-5xl text-indigo-600 animate-pulse">
            <i class="fas fa-satellite-dish"></i>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Running Tests</h2>
        <p id="progress-text" class="text-gray-500 mb-6 font-medium">Initializing...</p>
        <div class="w-full bg-gray-200 rounded-full h-4 mb-4 overflow-hidden shadow-inner">
            <div id="progress-bar" class="bg-indigo-600 h-4 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
        </div>
        <p id="progress-detail" class="text-xs text-gray-400 font-mono">Connecting to engine...</p>
    </div>
</div>

<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-95 hidden z-[100] flex justify-center items-center backdrop-blur-sm" onclick="closeModal()">
    <span class="absolute top-5 right-5 text-white text-4xl cursor-pointer hover:text-gray-300 transition">&times;</span>
    <img id="modal-img" class="max-w-[95%] max-h-[95%] p-2 object-contain rounded shadow-2xl">
</div>

<script>
    // --- UTILS ---
    function openResult() { document.getElementById('result-panel').classList.remove('translate-x-full'); }
    function closeResult() { document.getElementById('result-panel').classList.add('translate-x-full'); }
    function openModal(src) { if(!src) return; document.getElementById('modal-img').src = src; document.getElementById('image-modal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('image-modal').classList.add('hidden'); }
    document.addEventListener('keydown', (e) => { if(e.key === "Escape") { closeModal(); closeResult(); }});

    // --- BUTTON STATUS UPDATER (ROBUST FIX) ---
    function updateButtonStatus(id, data) {
        const btn = document.getElementById('btn-run-' + id);
        const badge = document.getElementById('badge-' + id);
        if(!btn || !badge) return;

        // Reset All Classes (Start fresh)
        btn.className = "flex-1 text-xs font-bold py-1.5 rounded transition flex justify-center items-center gap-2 border";
        badge.className = "hidden px-1.5 py-0.5 text-[10px] font-bold uppercase rounded border ml-2 shrink-0";
        badge.classList.add('hidden');

        if (data.status === 'PASS') {
            btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
            btn.innerHTML = "Passed";
            badge.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
            badge.classList.remove('hidden');
            badge.innerText = "0% DIFF";
        } else if (data.status === 'FAIL') {
            btn.classList.add('bg-red-100', 'text-red-700', 'border-red-200');
            btn.innerHTML = "Failed";
            badge.classList.add('bg-red-100', 'text-red-700', 'border-red-200');
            badge.classList.remove('hidden');
            badge.innerText = data.diffPercent + "% DIFF";
        } else {
            // ERROR STATE
            btn.classList.add('bg-orange-100', 'text-orange-600', 'border-orange-200');
            btn.innerHTML = "Error";
            // No badge for errors
        }
    }

    // --- LOADING STATE HELPER ---
    function setButtonLoading(id) {
        const btn = document.getElementById('btn-run-' + id);
        const badge = document.getElementById('badge-' + id);
        if(btn) {
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
            btn.className = "flex-1 bg-gray-100 text-gray-500 border border-gray-200 text-xs font-bold py-1.5 rounded transition flex justify-center items-center gap-2";
        }
        if(badge) badge.classList.add('hidden');
    }

    // --- RUN SINGLE TEST ---
    async function runTest(btn) {
        const id = btn.getAttribute('data-id');
        setButtonLoading(id);

        // Setup Result Panel
        openResult();
        document.getElementById('result-images').classList.add('hidden');
        document.getElementById('result-icon').innerHTML = '<i class="fas fa-circle-notch fa-spin text-indigo-500"></i>';
        document.getElementById('result-title').innerText = "Running Test...";
        document.getElementById('result-desc').innerText = "Comparing pixels between environments...";
        document.getElementById('pdf-btn').classList.add('hidden');

        try {
            const res = await fetch('/api/run-test/' + id, {method: 'POST'});
            const data = await res.json();

            // Update UI Button with correct color
            updateButtonStatus(id, data);

            // Update Result Panel
            if (data.status === 'ERROR') {
                document.getElementById('result-icon').innerHTML = '<i class="fas fa-exclamation-triangle text-orange-500"></i>';
                document.getElementById('result-title').innerText = "Error";
                document.getElementById('result-desc').innerText = data.message;
            } else {
                const ts = new Date().getTime();
                document.getElementById('img-staging').src = "/api/images/" + data.stagingImg + "?t=" + ts;
                document.getElementById('img-prod').src = "/api/images/" + data.prodImg + "?t=" + ts;
                document.getElementById('result-images').classList.remove('hidden');

                const pdfBtn = document.getElementById('pdf-btn');
                pdfBtn.classList.remove('hidden');
                pdfBtn.onclick = () => window.open(data.reportUrl, '_blank');

                if (data.status === 'PASS') {
                    document.getElementById('result-icon').innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
                    document.getElementById('result-title').innerText = "Passed";
                    document.getElementById('result-desc').innerText = "✅ Zero visual differences.";
                } else {
                    document.getElementById('result-icon').innerHTML = '<i class="fas fa-bug text-red-500"></i>';
                    document.getElementById('result-title').innerText = "Regression";
                    document.getElementById('result-desc').innerText = `❌ ${data.diffPercent}% difference detected.`;
                }
            }
        } catch (e) {
            updateButtonStatus(id, {status: 'ERROR'});
            document.getElementById('result-title').innerText = "System Error";
            document.getElementById('result-desc').innerText = "Check logs.";
        }
    }

    // --- RUN COLLECTION ---
    async function runCollection(collectionId) {
        const container = document.getElementById('col-group-' + collectionId);
        const buttons = container.querySelectorAll('[id^="btn-run-"]');
        const projectIds = Array.from(buttons).map(b => b.getAttribute('data-id'));

        if (projectIds.length === 0) { alert("Empty collection!"); return; }

        // Open Modal
        const modal = document.getElementById('progress-modal');
        const bar = document.getElementById('progress-bar');
        const text = document.getElementById('progress-text');
        const detail = document.getElementById('progress-detail');
        modal.classList.remove('hidden');

        // Reset all buttons in this collection to "Loading"
        projectIds.forEach(id => setButtonLoading(id));

        let completed = 0;
        const total = projectIds.length;

        for (const id of projectIds) {
            bar.style.width = Math.round((completed / total) * 100) + "%";
            text.innerText = `Progress: ${completed + 1}/${total}`;
            detail.innerText = `Analyzing Project ID: ${id}...`;

            try {
                const res = await fetch('/api/run-test/' + id, { method: 'POST' });
                const data = await res.json();
                updateButtonStatus(id, data);
            } catch (e) {
                console.error("Failed", e);
                updateButtonStatus(id, {status: 'ERROR'});
            }
            completed++;
        }

        // Generate Report
        bar.style.width = "100%";
        text.innerText = "Generating PDF...";

        try {
            const reportRes = await fetch('/api/generate-report/collection/' + collectionId, { method: 'POST' });
            const reportData = await reportRes.json();

            // Reveal PDF Button
            const downloadBtn = document.getElementById('btn-col-report-' + collectionId);
            if(downloadBtn) {
                downloadBtn.classList.remove('hidden');
                downloadBtn.onclick = () => window.open(reportData.reportUrl, '_blank');
            }

            setTimeout(() => {
                modal.classList.add('hidden');
                window.open(reportData.reportUrl, '_blank');
            }, 800);
        } catch (e) {
            alert("Report failed.");
            modal.classList.add('hidden');
        }
    }

    // --- BATCH RUNNER ---
    async function runBatch() {
        const buttons = document.querySelectorAll('[id^="btn-run-"]');
        const projectIds = Array.from(buttons).map(b => b.getAttribute('data-id'));
        if (projectIds.length === 0) return;

        const modal = document.getElementById('progress-modal');
        const bar = document.getElementById('progress-bar');
        const text = document.getElementById('progress-text');
        const detail = document.getElementById('progress-detail');
        const mainBtn = document.getElementById('btn-batch');

        modal.classList.remove('hidden');
        mainBtn.disabled = true;

        projectIds.forEach(id => setButtonLoading(id));

        let completed = 0;
        const total = projectIds.length;

        for (const id of projectIds) {
            bar.style.width = Math.round((completed / total) * 100) + "%";
            text.innerText = `Batch Progress: ${completed + 1}/${total}`;
            detail.innerText = `Analyzing ID: ${id}...`;

            try {
                const res = await fetch('/api/run-test/' + id, { method: 'POST' });
                const data = await res.json();
                updateButtonStatus(id, data);
            } catch (e) {
                updateButtonStatus(id, {status: 'ERROR'});
            }
            completed++;
        }

        bar.style.width = "100%";
        text.innerText = "Compiling Report...";

        try {
            const reportRes = await fetch('/api/generate-full-report', { method: 'POST' });
            const reportData = await reportRes.json();
            setTimeout(() => {
                modal.classList.add('hidden');
                mainBtn.innerHTML = '<i class="fas fa-file-download"></i> Download Report';
                mainBtn.onclick = () => window.open(reportData.reportUrl, '_blank');
                mainBtn.disabled = false;
                window.open(reportData.reportUrl, '_blank');
            }, 800);
        } catch (e) {
            alert("Report failed.");
            modal.classList.add('hidden');
            mainBtn.disabled = false;
        }
    }
</script>
</body>
</html>